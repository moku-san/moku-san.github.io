!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Router=e(),"function"!=typeof Object.assign&&(Object.assign=function(t){"use strict";if(null==t)throw new TypeError("Cannot convert undefined or null to object");t=Object(t);for(var e=1;e<arguments.length;e++){var o=arguments[e];if(null!=o)for(var r in o)Object.prototype.hasOwnProperty.call(o,r)&&(t[r]=o[r])}return t})}(this,function(){function n(t){var e=this._getSettings(t);if(this.notFoundHandler=e.page404,this.mode=window.history&&window.history.pushState?e.mode:"hash",this.root="/"===e.root?"/":"/"+this._trimSlashes(e.root)+"/",this.beforeHook=e.hooks.before,this.securityHook=e.hooks.secure,this.routes=[],e.routes&&0<e.routes.length){var o=this;e.routes.forEach(function(t){o.add(t.rule,t.handler,t.options)})}return this._pageState=null,this._currentPage=null,this._skipCheck=!1,this._action=null,"hash"===this.mode&&(this._historyStack=[],this._historyIdx=0,this._historyState="add"),this}return n.Page=function(t,e,o,r,i){this.uri=t||"",this.query=e||{},this.params=o||[],this.state=r||null,this.options=i||{}},n.prototype._getSettings=function(e){var o={},r={routes:[],mode:"history",root:"/",hooks:{before:function(){},secure:function(){return!0}},page404:function(t){console.error({page:t,message:"404. Page not found"})}};return e=e||{},["routes","mode","root","page404"].forEach(function(t){o[t]=e[t]||r[t]}),o.hooks=Object.assign({},r.hooks,e.hooks||{}),o},n.prototype._getHistoryFragment=function(){var t=decodeURI(window.location.pathname);return"/"!==this.root&&(t=t.replace(this.root,"")),this._trimSlashes(t)},n.prototype._getHashFragment=function(){var t=window.location.hash.substr(1).replace(/(\?.*)$/,"");return this._trimSlashes(t)},n.prototype._getFragment=function(){return"history"===this.mode?this._getHistoryFragment():this._getHashFragment()},n.prototype._trimSlashes=function(t){return"string"!=typeof t?"":t.toString().replace(/\/$/,"").replace(/^\//,"")},n.prototype._page404=function(t){this._currentPage=new n.Page(t),this.notFoundHandler(t)},n.prototype._parseRouteRule=function(t){if("string"!=typeof t)return t;var e=this._trimSlashes(t).replace(/([\\\/\-\_\.])/g,"\\$1").replace(/\{[a-zA-Z]+\}/g,"(:any)").replace(/\:any/g,"[\\w\\-\\_\\.]+").replace(/\:word/g,"[a-zA-Z]+").replace(/\:num/g,"\\d+");return new RegExp("^"+e+"$","i")},n.prototype._parseQuery=function(t){var o={};return"string"!=typeof t||("?"===t[0]&&(t=t.substr(1)),(this._queryString=t).split("&").forEach(function(t){var e=t.split("=");""!==e[0]&&(void 0===e[1]&&(e[1]=!0),o[decodeURIComponent(e[0])]=e[1])})),o},n.prototype._getHistoryQuery=function(){return this._parseQuery(window.location.search)},n.prototype._getHashQuery=function(){var t=window.location.hash.indexOf("?"),e=-1!==t?window.location.hash.substr(t):"";return this._parseQuery(e)},n.prototype._getQuery=function(){return"history"===this.mode?this._getHistoryQuery():this._getHashQuery()},n.prototype.add=function(t,e,o){return this.routes.push({rule:this._parseRouteRule(t),handler:e,options:o}),this},n.prototype.remove=function(o){var r=this;return"string"==typeof o&&(o=this._parseRouteRule(o).toString()),this.routes.some(function(t,e){return(t.handler===o||t.rule.toString()===o)&&(r.routes.splice(e,1),!0)}),this},n.prototype.reset=function(){return this.routes=[],this.mode=null,this.root="/",this._pageState={},this.removeUriListener(),this},n.prototype._pushHistory=function(){var t=this._getFragment();"hash"===this.mode&&("add"===this._historyState&&(this._historyIdx!==this._historyStack.length-1&&this._historyStack.splice(this._historyIdx+1),this._historyStack.push({path:t,state:this._pageState}),this._historyIdx=this._historyStack.length-1),this._historyState="add")},n.prototype._unloadCallback=function(t){var e;return this._skipCheck?!t||Promise.resolve(!0):this._currentPage&&this._currentPage.options&&this._currentPage.options.unloadCb?(e=this._currentPage.options.unloadCb(this._currentPage,t),!t||e instanceof Promise?e:e?Promise.resolve(e):Promise.reject(e)):!t||Promise.resolve(!0)},n.prototype._findRoute=function(){var i=this,s=this._getFragment();return this.routes.some(function(t){var e=s.match(t.rule);if(e){e.shift();var o=i._getQuery(),r=new n.Page(s,o,e,i._pageState,t.options);return!!i.securityHook(r)&&(i._currentPage=r,i._skipCheck?i._skipCheck=!1:(i.beforeHook(r),t.handler.apply(r,e),i._pageState=null,window.onbeforeunload=function(t){if(!i._unloadCallback(!1))return t.returnValue=!0}),!0)}return!1})},n.prototype._treatAsync=function(){var t;(t=this._currentPage.options.unloadCb(this._currentPage,!0))instanceof Promise||(t=t?Promise.resolve(t):Promise.reject(t)),t.then(this._processUri.bind(this)).catch(this._resetState.bind(this))},n.prototype._resetState=function(){this._skipCheck=!0,this.navigateTo(this._current,this._currentPage.state,!0)},n.prototype._processUri=function(){var t=this._getFragment();this._current=t,this._pushHistory(),this._findRoute.call(this)||this._page404(t)},n.prototype.check=function(){return this._skipCheck||(this._currentPage&&this._currentPage.options&&this._currentPage.options.unloadCb?this._treatAsync():this._processUri()),this},n.prototype.addUriListener=function(){return"history"===this.mode?window.onpopstate=this.check.bind(this):window.onhashchange=this.check.bind(this),this},n.prototype.removeUriListener=function(){return window.onpopstate=null,window.onhashchange=null,this},n.prototype.redirectTo=function(t,e,o){return t=this._trimSlashes(t)||"",this._pageState=e||null,this._skipCheck=!!o,"history"===this.mode?(history.replaceState(e,null,this.root+this._trimSlashes(t)),this.check()):(this._historyIdx--,window.location.hash=t,this)},n.prototype.navigateTo=function(t,e,o){return t=this._trimSlashes(t)||"",this._pageState=e||null,this._skipCheck=!!o,"history"===this.mode?(history.pushState(e,null,this.root+this._trimSlashes(t)),this.check()):(window.location.hash=t,this)},n.prototype.refresh=function(){if(!this._currentPage)return this;var t=this._currentPage.uri+"?"+this._queryString;return this.navigateTo(t,this._currentPage.state)},n.prototype.back=function(){return"history"===this.mode?(window.history.back(),this):this.go(this._historyIdx-1)},n.prototype.forward=function(){return"history"===this.mode?(window.history.forward(),this):this.go(this._historyIdx+1)},n.prototype.go=function(t){if("history"===this.mode)return window.history.go(t),this;var e=this._historyStack[t];return e?(this._historyIdx=t,this._historyState="hold",this.navigateTo(e.path,e.state)):this},n});